
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Koala Nachricht hochladen</title></head>
<body>
  <h2>ğŸ§¹ Koala Nachricht ersetzen</h2>
  <input type="file" id="upload" accept="audio/*,video/*"><br><br>
  <button id="uploadBtn">ğŸ“¤ Hochladen</button>
  <div id="status" style="white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 1em; margin-top: 1em;"></div>
  <div id="preview" style="margin-top: 1em;"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2"
    const supabase = createClient(
      "https://ejgjwijbbanpxylbrumr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZ2p3aWpiYmFucHh5bGJydW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDkwOTksImV4cCI6MjA2NDAyNTA5OX0.K3SuYyTYHO-5_QBZ0pMGTMgcpI0wdGTM5Zo65_shww0"
    );

    const log = (msg) => {
      const s = document.getElementById("status");
      s.innerText += "\n" + msg;
    }

    async function uploadFile() {
      const status = document.getElementById("status");
      const preview = document.getElementById("preview");
      status.innerText = "ğŸ” Upload beginnt... vorhandene Dateien werden gelÃ¶scht.";
      preview.innerHTML = "";

      const file = document.getElementById("upload").files[0];
      if (!file) {
        status.innerText = "âš ï¸ Bitte zuerst eine Datei auswÃ¤hlen.";
        return;
      }

      try {
        const userResp = await supabase.auth.getUser();
        const user = userResp.data.user;
        if (!user) {
          status.innerText = "âŒ Kein Benutzer angemeldet!";
          return;
        }

        const folder = user.id;
        const oldFiles = await supabase.storage.from("media").list(folder);
        if (oldFiles.data && oldFiles.data.length > 0) {
          for (let f of oldFiles.data) {
            await supabase.storage.from("media").remove([folder + "/" + f.name]);
            log("ğŸ—‘ï¸ Datei gelÃ¶scht: " + f.name);
          }
        }

        const filePath = folder + "/" + file.name;
        log("â¬†ï¸ Neue Datei wird hochgeladen...");
        const result = await supabase.storage.from("media").upload(filePath, file, { upsert: true });

        if (result.error) {
          status.innerText = "âŒ Fehler beim Upload: " + result.error.message;
        } else {
          const mediaUrl = supabase.storageUrl + "/object/public/media/" + filePath;
          const playbackUrl = "play.html?u=" + user.id;
          status.innerText = "âœ… Upload erfolgreich!";
          preview.innerHTML = `
            <p><strong>â–¶ï¸ Wiedergabe:</strong></p>
            <a href="${playbackUrl}" target="_blank"><button>Video ansehen</button></a>
            <p><a href="${mediaUrl}" target="_blank">${mediaUrl}</a></p>
          `;
        }
      } catch (err) {
        status.innerText = "ğŸš¨ Fehler: " + err.message;
      }
    }

    document.getElementById("uploadBtn").addEventListener("click", uploadFile);
  </script>
</body>
</html>
